<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>アンケートフォーム</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .date-cell.selected { background-color: #cce5ff; }
    .note-area { margin-top: 20px; }
  </style>
</head>
<body>
  <h1>アンケート回答</h1>

  <label>名前：<input type="text" id="username" /></label>

  <div id="calendar"></div>

  <div id="timeSelector" style="display:none; margin-top: 20px;">
    <p>時間帯を選択：</p>
    <label><input type="radio" name="type" value="Lunch">Lunch</label>
    <label><input type="radio" name="type" value="Dinner">Dinner</label>
    <label><input type="radio" name="type" value="Free">Free</label>
    <br><br>
    <label>開始：
      <select id="startHour"></select><span id="startColon">：</span><select id="startMin"></select>
    </label>
    <label>～ 終了：
      <select id="endHour"><option value="">--</option></select>：
      <select id="endMin"><option value="">--</option></select>
    </label>
    <br><br>
    <button onclick="saveAnswer()">決定</button>
    <button onclick="closeSelector()">戻る</button>
    <button onclick="removeAnswer()">取り消し</button>
  </div>

  <div class="note-area">
    <label>備考（任意）：</label><br>
    <textarea id="note" rows="3" cols="40"></textarea>
  </div>

  <br>
  <button onclick="submitForm()">送信</button>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getDatabase, ref, push } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDToeM2cPECKb22wElwSkCDsOMiEv_QU10",
      authDomain: "natura-shift.firebaseapp.com",
      databaseURL: "https://natura-shift-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "natura-shift",
      storageBucket: "natura-shift.firebasestorage.app",
      messagingSenderId: "485985022346",
      appId: "1:485985022346:web:29b59ab107cee81357d873"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const answers = {};
    let currentDate = null;

    // サンプル範囲（適宜動的に）
    const startDate = new Date("2025-04-16");
    const endDate = new Date("2025-04-30");

    function createCalendar() {
      const container = document.getElementById("calendar");
      container.innerHTML = "<h3>日付を選択：</h3>";
      const table = document.createElement("table");
      table.border = 1;
      let row = document.createElement("tr");

      const weekdays = ["月", "火", "水", "木", "金", "土", "日"];
      weekdays.forEach(d => {
        const th = document.createElement("th");
        th.textContent = d;
        row.appendChild(th);
      });
      table.appendChild(row);

      const dates = [];
      let temp = new Date(startDate);
      while (temp <= endDate) {
        dates.push(new Date(temp));
        temp.setDate(temp.getDate() + 1);
      }

      let weekRow = document.createElement("tr");
      const startDow = (startDate.getDay() + 6) % 7;
      for (let i = 0; i < startDow; i++) {
        weekRow.appendChild(document.createElement("td"));
      }

      dates.forEach((d, i) => {
        if (weekRow.children.length === 7) {
          table.appendChild(weekRow);
          weekRow = document.createElement("tr");
        }

        const td = document.createElement("td");
        td.textContent = d.getDate();
        td.className = "date-cell";
        const iso = d.toISOString().split("T")[0];
        td.dataset.date = iso;
        td.onclick = () => openSelector(iso, td);
        if (answers[iso]) {
          td.textContent += "\n" + formatAnswer(answers[iso]);
        }
        weekRow.appendChild(td);
      });

      while (weekRow.children.length < 7) {
        weekRow.appendChild(document.createElement("td"));
      }
      table.appendChild(weekRow);
      container.appendChild(table);
    }

    function openSelector(date, td) {
      document.querySelectorAll(".date-cell").forEach(cell => cell.classList.remove("selected"));
      td.classList.add("selected");
      currentDate = date;
      document.getElementById("timeSelector").style.display = "block";
    }

    function closeSelector() {
      document.getElementById("timeSelector").style.display = "none";
      document.querySelectorAll(".date-cell").forEach(cell => cell.classList.remove("selected"));
      currentDate = null;
    }

    function formatAnswer(ans) {
      if (!ans) return "";
      if (ans.type === "Lunch") {
        return ans.start.startsWith("10") ? `Lunch10~${ans.end || ""}` : `Lunch~${ans.end || ""}`;
      }
      if (ans.type === "Dinner") return `${ans.start}~${ans.end || ""}`;
      if (ans.type === "Free") return `Free~${ans.end || ""}`;
      return "";
    }

    function saveAnswer() {
      const type = document.querySelector("input[name='type']:checked")?.value;
      if (!type) return alert("時間帯を選択してください。");

      let start = "", end = "";
      if (type === "Lunch") {
        const h = document.getElementById("startHour").value;
        start = h === "10" ? "10:00" : "11:30";
        end = `${document.getElementById("endHour").value}:${document.getElementById("endMin").value}`;
      } else if (type === "Dinner") {
        start = `${document.getElementById("startHour").value}:${document.getElementById("startMin").value}`;
        const eH = document.getElementById("endHour").value;
        const eM = document.getElementById("endMin").value;
        if (eH && eM) end = `${eH}:${eM}`;
      } else if (type === "Free") {
        const eH = document.getElementById("endHour").value;
        const eM = document.getElementById("endMin").value;
        if (eH && eM) end = `${eH}:${eM}`;
      }

      answers[currentDate] = { type, start, end };
      createCalendar();
      closeSelector();
    }

    function removeAnswer() {
      if (currentDate) {
        delete answers[currentDate];
        createCalendar();
        closeSelector();
      }
    }

    function submitForm() {
      const name = document.getElementById("username").value.trim();
      const note = document.getElementById("note").value.trim();
      if (!name) return alert("名前を入力してください。");

      const newData = {
        name,
        note,
        answers
      };

      const refPath = ref(db, "responses");
      push(refPath, newData).then(() => {
        alert("ご回答ありがとうございました！");
        location.reload();
      });
    }

    window.onload = () => {
      createCalendar();
    };
  </script>
</body>
</html>
